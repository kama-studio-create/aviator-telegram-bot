<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviator Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
        }

        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 400px;
        }

        .login-card h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .admin-dashboard {
            display: none;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .connection-status {
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }

        .connection-status.connected {
            background: #27ae60;
            color: white;
        }

        .connection-status.disconnected {
            background: #e74c3c;
            color: white;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 80px;
            bottom: 0;
            width: 250px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar ul {
            list-style: none;
            padding: 20px 0;
        }

        .sidebar li {
            margin: 5px 0;
        }

        .sidebar a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            text-decoration: none;
            color: #34495e;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background: #ecf0f1;
            border-left-color: #3498db;
            color: #2c3e50;
        }

        .sidebar .icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            font-size: 16px;
        }

        .main-content {
            margin-left: 250px;
            padding: 30px;
            min-height: calc(100vh - 80px);
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #3498db;
        }

        .stat-card.revenue { border-left-color: #27ae60; }
        .stat-card.users { border-left-color: #e74c3c; }
        .stat-card.games { border-left-color: #f39c12; }
        .stat-card.profit { border-left-color: #9b59b6; }

        .stat-card h3 {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }

        .real-time {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 {
            font-size: 18px;
            color: #2c3e50;
        }

        .card-body {
            padding: 20px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .loading.show {
            display: block;
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #27ae60;
            border-radius: 50%;
            margin-right: 8px;
            animation: blink 1s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <h1>üõ©Ô∏è Aviator Admin</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="adminPassword">Admin Password</label>
                    <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                    Login to Dashboard
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div class="admin-dashboard" id="adminDashboard">
        <!-- Header -->
        <div class="header">
            <h1>üõ©Ô∏è Aviator Admin Dashboard</h1>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="connection-status" id="connectionStatus">Connecting...</div>
                <span>Admin Panel</span>
                <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <ul>
                <li><a href="#" class="nav-link active" data-section="dashboard">
                    <span class="icon">üìä</span> Dashboard
                </a></li>
                <li><a href="#" class="nav-link" data-section="users">
                    <span class="icon">üë•</span> User Management
                </a></li>
                <li><a href="#" class="nav-link" data-section="games">
                    <span class="icon">üéÆ</span> Game Control
                </a></li>
                <li><a href="#" class="nav-link" data-section="system">
                    <span class="icon">üñ•Ô∏è</span> System Status
                </a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboard">
                <div class="stats-grid">
                    <div class="stat-card revenue">
                        <h3>Total Revenue</h3>
                        <div class="value real-time" id="totalRevenue">0 ‚≠ê</div>
                    </div>
                    <div class="stat-card users">
                        <h3>Active Users</h3>
                        <div class="value real-time" id="activeUsers">0</div>
                    </div>
                    <div class="stat-card games">
                        <h3>Games Played</h3>
                        <div class="value real-time" id="gamesPlayed">0</div>
                    </div>
                    <div class="stat-card profit">
                        <h3>Current Game</h3>
                        <div class="value" id="currentGameInfo">-</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2><span class="live-indicator"></span>Live Game Status</h2>
                        <div id="gameControls">
                            <button class="btn btn-warning btn-sm" onclick="forceNextCrash()">üéØ Force Crash</button>
                            <button class="btn btn-danger btn-sm" onclick="broadcastMessage()">üì¢ Broadcast</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                            <div>
                                <h4>Game ID</h4>
                                <p id="liveGameId">-</p>
                            </div>
                            <div>
                                <h4>State</h4>
                                <p id="liveGameState">-</p>
                            </div>
                            <div>
                                <h4>Players</h4>
                                <p id="livePlayers">0</p>
                            </div>
                            <div>
                                <h4>Multiplier</h4>
                                <p id="liveMultiplier">1.00x</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Recent Games</h2>
                        <button class="btn btn-primary btn-sm" onclick="refreshDashboard()">üîÑ Refresh</button>
                    </div>
                    <div class="card-body">
                        <div class="loading" id="gamesLoading">Loading...</div>
                        <table class="table" id="recentGamesTable">
                            <thead>
                                <tr>
                                    <th>Game ID</th>
                                    <th>Crash Point</th>
                                    <th>Players</th>
                                    <th>Total Bets</th>
                                    <th>House Profit</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="recentGamesBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div class="content-section" id="users">
                <div class="card">
                    <div class="card-header">
                        <h2>User Management</h2>
                        <div style="display: flex; gap: 10px;">
                            <select id="userFilter" class="form-control" style="width: auto;" onchange="filterUsers()">
                                <option value="all">All Users</option>
                                <option value="active">Active Users</option>
                                <option value="banned">Banned Users</option>
                                <option value="vip">VIP Users</option>
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="refreshUsers()">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="loading" id="usersLoading">Loading...</div>
                        <table class="table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Balance</th>
                                    <th>Total Wagered</th>
                                    <th>Win Rate</th>
                                    <th>Status</th>
                                    <th>Last Active</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Games Section -->
            <div class="content-section" id="games">
                <div class="card">
                    <div class="card-header">
                        <h2>Game Control</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Force Next Crash Point</label>
                                <input type="number" id="forceCrashInput" class="form-control" min="1" max="1000" step="0.01" placeholder="e.g. 2.50">
                            </div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button class="btn btn-warning" onclick="setForcedCrash()" style="width: 100%;">üéØ Set Custom Crash</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Broadcast Message</label>
                            <textarea id="broadcastText" class="form-control" rows="3" placeholder="Enter message to broadcast to all players..."></textarea>
                            <button class="btn btn-primary" onclick="sendBroadcast()" style="margin-top: 10px;">üì¢ Send to All Players</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Game History</h2>
                        <button class="btn btn-primary btn-sm" onclick="loadGameHistory()">üîÑ Refresh</button>
                    </div>
                    <div class="card-body">
                        <div class="loading" id="historyLoading">Loading...</div>
                        <table class="table" id="gameHistoryTable">
                            <thead>
                                <tr>
                                    <th>Game ID</th>
                                    <th>Crash Point</th>
                                    <th>Players</th>
                                    <th>Total Bets</th>
                                    <th>House Profit</th>
                                    <th>Timestamp</th>
                                    <th>Verify</th>
                                </tr>
                            </thead>
                            <tbody id="gameHistoryBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- System Section -->
            <div class="content-section" id="system">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Server Uptime</h3>
                        <div class="value" id="systemUptime">0h 0m</div>
                    </div>
                    <div class="stat-card">
                        <h3>Memory Usage</h3>
                        <div class="value" id="systemMemory">0 MB</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Connections</h3>
                        <div class="value" id="systemConnections">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Current Game</h3>
                        <div class="value" id="systemGameInfo">-</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>System Information</h2>
                        <button class="btn btn-primary btn-sm" onclick="refreshSystemStatus()">üîÑ Refresh</button>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Game State</label>
                                <input type="text" id="currentGameState" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label>WebSocket Status</label>
                                <input type="text" id="websocketStatus" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let adminToken = null;
        let socket = null;
        let dashboardData = {};
        
        // Authentication
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            
            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    adminToken = data.token;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'block';
                    initializeAdminSocket();
                    loadDashboard();
                } else {
                    alert('Invalid password');
                }
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        });

        function logout() {
            adminToken = null;
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminDashboard').style.display = 'none';
        }

        // WebSocket initialization for real-time updates
        function initializeAdminSocket() {
            console.log('üîå Initializing admin socket...');
            
            socket = io({
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                console.log('‚úÖ Admin socket connected');
                updateConnectionStatus('connected');
                
                // Authenticate as admin
                socket.emit('adminAuth', { token: adminToken });
            });

            socket.on('disconnect', () => {
                console.log('‚ùå Admin socket disconnected');
                updateConnectionStatus('disconnected');
            });

            // Real-time game updates
            socket.on('bettingPhase', (data) => {
                console.log('üìä Betting phase started:', data);
                updateLiveGameStatus({
                    gameId: data.gameId,
                    state: 'betting',
                    players: 0,
                    multiplier: 1.00
                });
            });

            socket.on('flightStarted', (data) => {
                console.log('üìä Flight started:', data);
                updateLiveGameStatus({
                    gameId: data.gameId,
                    state: 'playing',
                    multiplier: 1.00
                });
            });

            socket.on('altitudeUpdate', (data) => {
                updateLiveGameStatus({
                    multiplier: data.altitude,
                    state: 'playing'
                });
            });

            socket.on('ticketPurchased', (data) => {
                console.log('üìä Ticket purchased:', data);
                updateLiveGameStatus({
                    players: data.totalPassengers
                });
            });

            socket.on('planeCrashed', (data) => {
                console.log('üìä Plane crashed:', data);
                updateLiveGameStatus({
                    gameId: data.gameId,
                    state: 'crashed',
                    multiplier: data.crashPoint
                });
                
                // Refresh dashboard data
                setTimeout(loadDashboard, 2000);
            });

            socket.on('adminData', (data) => {
                console.log('üìä Admin data received:', data);
                dashboardData = data;
                updateDashboardStats();
            });
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            
            if (status === 'connected') {
                statusEl.textContent = 'üü¢ Connected';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = 'üî¥ Disconnected';
                statusEl.className = 'connection-status disconnected';
            }
        }

        function updateLiveGameStatus(updates) {
            if (updates.gameId !== undefined) {
                document.getElementById('liveGameId').textContent = `#${updates.gameId}`;
            }
            if (updates.state !== undefined) {
                document.getElementById('liveGameState').textContent = updates.state;
                document.getElementById('liveGameState').style.color = 
                    updates.state === 'playing' ? '#27ae60' : 
                    updates.state === 'crashed' ? '#e74c3c' : '#f39c12';
            }
            if (updates.players !== undefined) {
                document.getElementById('livePlayers').textContent = updates.players;
            }
            if (updates.multiplier !== undefined) {
                document.getElementById('liveMultiplier').textContent = updates.multiplier.toFixed(2) + 'x';
                document.getElementById('liveMultiplier').style.color = 
                    updates.multiplier >= 5 ? '#e74c3c' : 
                    updates.multiplier >= 2 ? '#f39c12' : '#27ae60';
            }
        }

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.dataset.section;
                showSection(section);
                
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            });
        });

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // Load section-specific data
            switch(sectionId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'games':
                    loadGameHistory();
                    break;
                case 'system':
                    loadSystemStatus();
                    break;
            }
        }

        // API Helper
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(endpoint, options);
            
            if (!response.ok) {
                throw new Error(`API call failed: ${response.statusText}`);
            }
            
            return response.json();
        }

        // Dashboard Functions
        async function loadDashboard() {
            try {
                const data = await apiCall('/api/admin/dashboard');
                
                document.getElementById('totalRevenue').textContent = `${data.totalRevenue.toLocaleString()} ‚≠ê`;
                document.getElementById('activeUsers').textContent = data.activeUsers.toLocaleString();
                document.getElementById('gamesPlayed').textContent = data.totalGames.toLocaleString();
                document.getElementById('currentGameInfo').textContent = 
                    `#${data.currentGame.gameId} (${data.currentGame.players} players)`;

                // Update live game status
                updateLiveGameStatus({
                    gameId: data.currentGame.gameId,
                    state: data.currentGame.state,
                    players: data.currentGame.players,
                    multiplier: data.currentGame.currentMultiplier
                });

                // Load recent games
                loadRecentGames();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showNotification('Failed to load dashboard data', 'error');
            }
        }

        async function loadRecentGames() {
            try {
                document.getElementById('gamesLoading').classList.add('show');
                const data = await apiCall('/api/admin/games/history?limit=10');
                
                const tbody = document.getElementById('recentGamesBody');
                tbody.innerHTML = '';
                
                data.games.forEach(game => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>#${game.gameId}</td>
                        <td>${game.crashPoint.toFixed(2)}x</td>
                        <td>${game.results ? game.results.length : 0}</td>
                        <td>${game.totalBets.toLocaleString()} ‚≠ê</td>
                        <td>${game.houseProfit.toLocaleString()} ‚≠ê</td>
                        <td>${new Date(game.timestamp).toLocaleTimeString()}</td>
                    `;
                });
                
                document.getElementById('gamesLoading').classList.remove('show');
            } catch (error) {
                console.error('Error loading recent games:', error);
                document.getElementById('gamesLoading').classList.remove('show');
            }
        }

        // User Management Functions
        async function loadUsers() {
            try {
                document.getElementById('usersLoading').classList.add('show');
                const filter = document.getElementById('userFilter').value;
                const data = await apiCall(`/api/admin/users?filter=${filter}&limit=50`);
                
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                
                data.users.forEach(user => {
                    const row = tbody.insertRow();
                    const winRate = user.totalBets > 0 ? ((user.totalWins / user.totalBets) * 100).toFixed(1) : '0.0';
                    
                    let statusBadge = '';
                    if (user.isBanned) statusBadge = '<span class="badge badge-danger">Banned</span>';
                    else if (user.isVIP) statusBadge = '<span class="badge badge-success">VIP</span>';
                    else statusBadge = '<span class="badge badge-success">Active</span>';
                    
                    row.innerHTML = `
                        <td>
                            <div>
                                <strong>${user.username}</strong><br>
                                <small>ID: ${user.telegramId}</small>
                            </div>
                        </td>
                        <td>${user.balance.toLocaleString()} ‚≠ê</td>
                        <td>${user.totalWagered.toLocaleString()} ‚≠ê</td>
                        <td>${winRate}%</td>
                        <td>${statusBadge}</td>
                        <td>${new Date(user.lastActive).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="giveBonus(${user.telegramId})">üí∞ Bonus</button>
                            ${user.isBanned ? 
                                `<button class="btn btn-success btn-sm" onclick="toggleBan(${user.telegramId}, 'unban')">‚úÖ Unban</button>` :
                                `<button class="btn btn-danger btn-sm" onclick="toggleBan(${user.telegramId}, 'ban')">üö´ Ban</button>`
                            }
                        </td>
                    `;
                });
                
                document.getElementById('usersLoading').classList.remove('show');
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersLoading').classList.remove('show');
                showNotification('Failed to load users', 'error');
            }
        }

        async function giveBonus(userId) {
            const amount = prompt('Enter bonus amount (Stars):');
            if (amount && !isNaN(amount) && parseInt(amount) > 0) {
                try {
                    await apiCall(`/api/admin/users/${userId}/bonus`, 'POST', {
                        amount: parseInt(amount)
                    });
                    
                    showNotification('Bonus given successfully!', 'success');
                    loadUsers();
                } catch (error) {
                    showNotification('Failed to give bonus: ' + error.message, 'error');
                }
            }
        }

        async function toggleBan(userId, action) {
            const reason = action === 'ban' ? (prompt('Ban reason:') || 'Admin action') : null;
            
            try {
                await apiCall(`/api/admin/users/${userId}/ban`, 'POST', {
                    action,
                    reason
                });
                
                showNotification(`User ${action}ned successfully!`, 'success');
                loadUsers();
            } catch (error) {
                showNotification(`Failed to ${action} user: ` + error.message, 'error');
            }
        }

        function filterUsers() {
            loadUsers();
        }

        function refreshUsers() {
            loadUsers();
        }

        // Game Management Functions
        async function loadGameHistory() {
            try {
                document.getElementById('historyLoading').classList.add('show');
                const data = await apiCall('/api/admin/games/history?limit=20');
                
                const tbody = document.getElementById('gameHistoryBody');
                tbody.innerHTML = '';
                
                data.games.forEach(game => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>#${game.gameId}</td>
                        <td>${game.crashPoint.toFixed(2)}x</td>
                        <td>${game.results ? game.results.length : 0}</td>
                        <td>${game.totalBets.toLocaleString()} ‚≠ê</td>
                        <td>${game.houseProfit.toLocaleString()} ‚≠ê</td>
                        <td>${new Date(game.timestamp).toLocaleString()}</td>
                        <td><button class="btn btn-primary btn-sm" onclick="verifyGame(${game.gameId})">üîç Verify</button></td>
                    `;
                });
                
                document.getElementById('historyLoading').classList.remove('show');
            } catch (error) {
                console.error('Error loading game history:', error);
                document.getElementById('historyLoading').classList.remove('show');
            }
        }

        async function setForcedCrash() {
            const multiplier = document.getElementById('forceCrashInput').value;
            if (!multiplier || multiplier < 1 || multiplier > 1000) {
                showNotification('Please enter a valid multiplier between 1.0 and 1000.0', 'error');
                return;
            }
            
            try {
                const result = await apiCall('/api/admin/games/force-crash', 'POST', {
                    multiplier: parseFloat(multiplier)
                });
                
                if (result.success) {
                    showNotification(`Next game will crash at ${multiplier}x`, 'success');
                    document.getElementById('forceCrashInput').value = '';
                }
            } catch (error) {
                showNotification('Failed to set crash point: ' + error.message, 'error');
            }
        }

        async function sendBroadcast() {
            const message = document.getElementById('broadcastText').value.trim();
            if (!message) {
                showNotification('Please enter a message', 'error');
                return;
            }
            
            try {
                await apiCall('/api/admin/notifications/broadcast', 'POST', {
                    message,
                    type: 'info'
                });
                
                showNotification('Broadcast sent successfully!', 'success');
                document.getElementById('broadcastText').value = '';
            } catch (error) {
                showNotification('Failed to send broadcast: ' + error.message, 'error');
            }
        }

        async function verifyGame(gameId) {
            try {
                const verification = await fetch(`/api/verify/${gameId}`);
                const data = await verification.json();
                
                if (data.error) {
                    showNotification('Game not found', 'error');
                    return;
                }

                alert(`Game #${gameId} Verification:\n\nCrash Point: ${data.crashPoint.toFixed(2)}x\nServer Seed: ${data.serverSeed}\nClient Seed: ${data.clientSeed}\nValid: ${data.isValid ? 'YES' : 'NO'}`);
            } catch (error) {
                showNotification('Failed to verify game', 'error');
            }
        }

        // System Status Functions
        async function loadSystemStatus() {
            try {
                const data = await apiCall('/api/admin/system/status');
                
                const uptimeHours = Math.floor(data.uptime / 3600);
                const uptimeMinutes = Math.floor((data.uptime % 3600) / 60);
                
                document.getElementById('systemUptime').textContent = `${uptimeHours}h ${uptimeMinutes}m`;
                document.getElementById('systemMemory').textContent = `${data.memory.used} MB`;
                document.getElementById('systemConnections').textContent = data.activeConnections;
                document.getElementById('systemGameInfo').textContent = 
                    `Game #${data.currentGame.id} - ${data.currentGame.state}`;
                
                document.getElementById('currentGameState').value = 
                    `Game #${data.currentGame.id} - ${data.currentGame.state} (${data.currentGame.players} players)`;
                document.getElementById('websocketStatus').value = 
                    socket && socket.connected ? 'Connected' : 'Disconnected';
                    
            } catch (error) {
                console.error('Error loading system status:', error);
                showNotification('Failed to load system status', 'error');
            }
        }

        // Quick action functions
        function forceNextCrash() {
            const multiplier = prompt('Enter crash multiplier (1.0 - 1000.0):');
            if (multiplier && !isNaN(multiplier) && multiplier >= 1 && multiplier <= 1000) {
                document.getElementById('forceCrashInput').value = multiplier;
                setForcedCrash();
            }
        }

        function broadcastMessage() {
            const message = prompt('Enter message to broadcast:');
            if (message && message.trim()) {
                document.getElementById('broadcastText').value = message.trim();
                sendBroadcast();
            }
        }

        function refreshDashboard() {
            loadDashboard();
        }

        function refreshSystemStatus() {
            loadSystemStatus();
        }

        // Notification system
        function showNotification(message, type = 'info') {
            console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
            
            // Create notification element if it doesn't exist
            let notification = document.getElementById('adminNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'adminNotification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 5px;
                    color: white;
                    font-weight: bold;
                    z-index: 10000;
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                `;
                document.body.appendChild(notification);
            }
            
            // Set notification style based on type
            const colors = {
                success: '#27ae60',
                error: '#e74c3c',
                warning: '#f39c12',
                info: '#3498db'
            };
            
            notification.style.backgroundColor = colors[type] || colors.info;
            notification.textContent = message;
            notification.style.transform = 'translateX(0)';
            
            // Hide after 4 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
            }, 4000);
        }

        // Auto-refresh for real-time updates
        setInterval(() => {
            if (document.querySelector('.content-section.active').id === 'dashboard') {
                loadDashboard();
            } else if (document.querySelector('.content-section.active').id === 'system') {
                loadSystemStatus();
            }
        }, 30000); // Refresh every 30 seconds

        // Auto-refresh users list every 60 seconds
        setInterval(() => {
            if (document.querySelector('.content-section.active').id === 'users') {
                loadUsers();
            }
        }, 60000);

        // Initialize dashboard on load (after login)
        function initializeDashboard() {
            loadDashboard();
            
            // Set up periodic refreshes
            setInterval(() => {
                const activeSection = document.querySelector('.content-section.active').id;
                if (activeSection === 'dashboard') {
                    loadDashboard();
                }
            }, 10000); // Every 10 seconds for dashboard
        }
    </script>
</body>
</html>